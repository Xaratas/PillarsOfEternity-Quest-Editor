<script>
FlowChartNodeBehavior = {
	properties: {
			type: String,
			nodeId: Number,
			comments: Array,
			links: Object,

            linkXML: Object,

			draggable: {
				value: "true",
				reflectToAttribute: true
			},
			id: {
				computed: 'setId(type, nodeId)',
				reflectToAttribute: true
			},
			direction: String
		},

        listeners: {
			'dragstart': 'onDragStart',
			'dragover': 'onDragOver',
			'dragenter': 'onDragEnter',
			'dragleave': 'onDragLeave',
			'drop': 'onDrop',
			'dragend': 'onDragEnd'
		},
		
		setId: function(type, nodeId) {
			return type + nodeId; // node id sollte unique bleiben, TODO enforce davon
		},

		addComment: function(text) {
			var comment = new Comment(this, this.comments.length + 1);
			if(text !== undefined)
				comment.setText(text);
			this.push("comments", comment);
        	Polymer.dom(this.$$("comments")).appendChild(comment, this.$$("comments"));
		},

		removeComment: function(index) {
			console.log("remove Comment");
			var comment = this.splice("comments", index - 1, 1)[0]; // splice liefert ein array
			Polymer.dom(this.$$("comments")).removeChild(comment); // die remove child erwartet eine node, deswegen über comment und nicht über id
		},

		//http://www.quirksmode.org/blog/archives/2009/09/the_html5_drag.html Ja verdammt, drag and drop ist fürn arsch, und das wird auch in HTML 5.1 so bleiben
		onDragStart: function(event) {
			event.dataTransfer.effectsAllowed = 'link';
			event.dataTransfer.setData("id", this.id); // type could be anything, as long as it is string, oh and data have to be string too …
			this.direction = "from";
		},

		onDragEnter: function(event) {
			event.preventDefault();
		},

		onDragOver: function(event) {
			event.preventDefault();
			// todo nur typgleiche verlinken
			event.dataTransfer.dropEffect = 'link';
			if(this.direction !== "from") {
				this.direction = "to";
			}
		},

		onDragLeave: function(event) {
			if(this.direction !== "from") {
				this.direction = "";
			}
		},

		onDrop: function(event) {
			event.preventDefault();
			// todo: handling für verschiedene nodes, prototypisch für überhaupt links
			// todo: links sind nur in eine richtung zu ziehen
			if(event.dataTransfer.getData("id") !== this.id) { // selbst linken ist nicht
				var from = document.getElementById(event.dataTransfer.getData("id"));
				from.createLink(this);
			}
			this.direction = ""; // drag target
		},

		onDragEnd: function(event) {
			console.log("Fin");
			this.direction = ""; // drag source
		},
};
</script>