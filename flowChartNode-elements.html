<link rel="import" href="bower_components/iron-input/iron-input.html">
<link rel="import" href="flowChartNode-behavior.html">
<link rel="import" href="comment-element.html">
<link rel="import" href="condition-element.html">

<!-- Contains the different kind of FlowChartNodes -->
<!-- The common base and drag and drop is in flowChartNode-behavior defined -->


<dom-module id="FlowChartNode-element">
<style>
	:host {
		background-color: var(--FlowChartNode-element-background-color);
		width: 260px;
		display: flex;
		margin: 10px;
	}
	
	:host.selected {
		background-color: var(--FlowChartNode-element-selected-color);
	}

	.direction {
		float: right;
	}

	.left, .right, .leftmiddle {
		width: 40px;
		padding: 10px 5px;
		background-color: var(--FlowChartNode-element-popup-target-color);
		position: relative;
	}

	.left {
		border-top-right-radius: 20px;
		border-bottom-right-radius: 20px;
		padding-right: 18px;
	}

	.right {
		border-top-left-radius: 20px;
		border-bottom-left-radius: 20px;
		padding-right: 18px;
	}

	.leftmiddle {
		border-radius: 20px;
		padding: 12px;
		margin-left: 3px;
	}
	.center {
		margin: 10px;
	}

	.left > span, .leftmiddle > span {
	    position: absolute;
		transform: translate(0px, -12px) rotate(90deg);
	    transform-origin: left bottom 0;
	}

	.leftmiddle > span {
		transform: translate(-4px, -26px) rotate(90deg);
	}
	
	.left > conditions, .leftmiddle > enterScripts, .right > exitScripts {
		display: none;
		position: absolute;
		width: 500px;
		background-color: #ADBF97;
		z-index: 10;
		left: 25px;
		top: 30px;
		padding: 10px;
	}

	.left:hover > conditions, .leftmiddle:hover > enterScripts, .right:hover > exitScripts {
		display: block;
	}

	conditions:hover, enterScripts:hover, exitScripts:hover {
		display: block;
	}
	
	.right > span {
		position: absolute;
	    transform: translate(0px, 86px) rotate(270deg);
	    transform-origin: left top 0;
	}

	comments {
	}
</style>
<template>
		<div class="left">
			<span>Conditions</span>
			<conditions></conditions>
		</div>
		<div class="leftmiddle">
			<span>Enter&nbsp;Scripts</span>
			<enterScripts></enterScripts>
		</div>
		<div class="center">
			<div>Type: <span>{{type}}</span><span class="direction">{{direction}}</span></div>
			<div>ID: <input is="iron-input" bind-value={{nodeId}}></input></div>
			<div>Comments: <button on-click="addComment">Add</button></div>
			<comments></comments>
		</div>
		<div class="right" on-click="showEffects">
			<span>Exit&nbsp;Scripts</span>
			<exitScripts></exitScripts>
		</div>
</template>
</dom-module>

<dom-module id="QuestNode-element">
	<style>
		:host {
			--FlowChartNode-element-background-color: #96C5F7;
			--FlowChartNode-element-popup-target-color: #A9D3FF;
			--FlowChartNode-element-selected-color: #6782A7;
		}	
	</style>
	<template>
		<flowchartnode-element id="flowchartnode" direction="{{direction}}"></flowchartnode-element>
	</template>
</dom-module>

<dom-module id="ObjectiveNode-element">
	<style>
		:host {
			--FlowChartNode-element-background-color: #96C5F7;
			--FlowChartNode-element-popup-target-color: #A9D3FF;
			--FlowChartNode-element-selected-color: #6782A7;
		}	
	</style>
	<template>
		<flowchartnode-element id="flowchartnode" direction="{{direction}}"></flowchartnode-element>
	</template>
</dom-module>

<dom-module id="DialogueNode-element">
	<template>
		<flowchartnode-element id="flowchartnode" direction="{{direction}}"></flowchartnode-element>
	</template>
</dom-module>

<dom-module id="TalkNode-element">
	<style>
		:host {
			--FlowChartNode-element-background-color: #8FC0A9;
			--FlowChartNode-element-popup-target-color: #9FD8CB;
			--FlowChartNode-element-selected-color: #E2EB98;
		}	
	</style>
	<template>
		<dialoguenode-element id="dialoguenode" direction="{{direction}}"></dialoguenode-element>
	</template>
</dom-module>

<dom-module id="PlayerResponseNode-element">
	<style>
		:host {
			--FlowChartNode-element-background-color: #8FC0A9;
			--FlowChartNode-element-popup-target-color: #9FD8CB;
			--FlowChartNode-element-selected-color: #E2EB98;
		}	
	</style>
	<template>
		<dialoguenode-element id="dialoguenode" direction="{{direction}}"></dialoguenode-element>
	</template>
</dom-module>

<dom-module id="TriggerConversationNode-element">
	<style>
		:host {
			--FlowChartNode-element-background-color: #8FC0A9;
			--FlowChartNode-element-popup-target-color: #9FD8CB;
			--FlowChartNode-element-selected-color: #E2EB98;
		}	
	</style>
	<template>
		<dialoguenode-element id="dialoguenode" direction="{{direction}}"></dialoguenode-element>
	</template>
</dom-module>

<dom-module id="BankNode-element">
	<style>
		:host {
			--FlowChartNode-element-background-color: #8FC0A9;
			--FlowChartNode-element-popup-target-color: #9FD8CB;
			--FlowChartNode-element-selected-color: #E2EB98;
		}	
	</style>
	<template>
		<flowchartnode-element id="flowchartnode" direction="{{direction}}"></flowchartnode-element>
	</template>
</dom-module>

<dom-module id="ScriptNode-element">
	<style>
		:host {
			--FlowChartNode-element-background-color: #8FC0A9;
			--FlowChartNode-element-popup-target-color: #9FD8CB;
			--FlowChartNode-element-selected-color: #E2EB98;
		}	
	</style>
	<template>
		<dialoguenode-element id="dialoguenode" direction="{{direction}}"></dialoguenode-element>
	</template>
</dom-module>

<script>
"use strict";
document.addEventListener('WebComponentsReady', function() {
	window.FlowChartNode = Polymer({
		is: "FlowChartNode-element",
		behaviors: [FlowChartNodeBehavior],

		created: function() {
			this.comments = [];
			this.links = {};
			this.conditions = [];
			this.enterScripts = [];
			this.exitScripts = [];
			this.conditions = [];
		},

		/** Create Links via Drag and Drop */
		createLink: function(to) {
			if (!(to.id in this.links)) {
				this.links[to.id] = new DialogueLink(this, to);
				document.getElementsByTagName("body")[0].appendChild(this.links[to.id]);
			}
		},

		activateLinks: function(nodesMap) { // linkXML in echte links überführen
			if (this.linkXML.hasChildNodes()) {
				var node;
				for (var x = 0; x < this.linkXML.childNodes.length; x++) {
					node = this.linkXML.childNodes[x];
					if (node.nodeName == "FlowChartLink") {
						var link;
						switch(this.type) {
							case "TalkNode":
							case "PlayerResponseNode":
							case "TriggerConversationNode":
							case "BankNode":
							case "ScriptNode": link = new DialogueLink();
									link.fromXML(node, nodesMap);
									break;
							case "QuestNode":
							case "ObjectiveNode": link = new QuestLink();
									link.fromXML(node, nodesMap);
									break;
						}
						this.links[link.endElement.id] = link;
					}
				}
			}
		}
	});

	window.QuestNode = Polymer({
		is: "QuestNode-element",
		behaviors: [UIBehavior],
		
		properties: {
			endStates: Array,
			experienceType: String,
			experienceLevel: Number,

			type: {
				value: 'QuestNode'
			}
		},
		
		created: function() {
			this.endStates = [];
		},

		factoryImpl: function(parent_) {
			this.parent_ = parent_;
			this.links = this.$.flowchartnode.links;
		},

		createLink: function(to) {
			this.$.flowchartnode.creatLink(to);
		},

		fromXML: function(xml) {
			this.nodeId = this.$.flowchartnode.fromXML(xml);
			if (xml.hasChildNodes()) {
				var node;
				for (var x = 0; x < xml.childNodes.length; x++) {
					node = xml.childNodes[x];
					if (node.nodeName == "EndStates") {
						if(node.hasChildNodes()) {
							var state;
							for(var i = 0; i < node.childNodes.length; i++) {
								state = node.childNodes[i];
								if(state.hasChildNodes()) {
									var endStateId = state.childNodes[0].textContent;
									var displayName = state.childNodes[1].textContent;
									var packageId = state.childNodes[2].textContent;
									this.endStates[i] = {'endStateId': endStateId, 'displayName': displayName, 'packageId': packageId};
								}
							}
						}
					}
					if (node.nodeName == "ExperienceType") {
						this.experienceType = node.textContent;
					}
					if (node.nodeName == "ExperienceLevel") {
						this.experienceLevel = node.textContent;
					}
				}
			}
		},

		toXML: function() {
			var xml = '<EndStates>';
			for(var i = 0; i < this.endStates.length; i++) {
				xml += '<QuestEndState>';
				xml += '<EndStateID>' + this.endStates[i].endStateId + '</EndStateID>';
				xml += '<DisplayName>' + this.endStates[i].displayName + '</DisplayName>';
				xml += '<PackageID>' + this.endStates[i].packageId + '</PackageID>';
				xml += '</QuestEndState>';
			}
			xml += '</EndStates>';
			xml += '<ExperienceType>' + this.experienceType + '</ExperienceType>';
			xml += '<ExperienceLevel>' + this.experienceLevel + '</ExperienceLevel>';
			return '<FlowChartNode xsi:type="' + this.type + '">' + this.$.flowchartnode.toXML(xml) + '</FlowChartNode>';
		}
	});

	window.ObjectiveNode = Polymer({
		is: "ObjectiveNode-element",
		behaviors: [UIBehavior],

		properties: {
			addendumIds: Array,
			experienceWeight: Number,
		
			type: {
				value: 'ObjectiveNode'
			}
		},

		created: function() {
			this.addendumIds = [];
		},

		factoryImpl: function(parent_) {
			this.parent_ = parent_;
			this.links = this.$.flowchartnode.links;
		},

		createLink: function(to) {
			this.$.flowchartnode.creatLink(to);
		},

		// TODO linktypen vereinheitlichen

		fromXML: function(xml) {
			this.nodeId = this.$.flowchartnode.fromXML(xml);
			if (xml.hasChildNodes()) {
				var node;
				for (var x = 0; x < xml.childNodes.length; x++) {
					node = xml.childNodes[x];
					if (node.nodeName == "AddendumIDs") {
						var addendum = node.childNodes;
						for(var i = 0; i < addendum.length; i++) {
							this.addendumIds[i] = addendum[i].textContent;	
						}
					}
					if (node.nodeName == "ExperienceWeight") {
						this.experienceWeight = node.textContent;
					}
				}
			}
		},

		toXML: function() {
			var xml = '<AddendumIDs>';
			for(var id of this.addendumIds) {
				xml += '<int>' + id + '</int>';
			}
			xml += '</AddendumIDs>';
			xml += '<ExperienceWeight>' + this.experienceWeight + '</ExperienceWeight>';
			return '<FlowChartNode xsi:type="' + this.type + '">' + this.$.flowchartnode.toXML(xml) + '</FlowChartNode>';
		}
	});

	window.DialogueNode = Polymer({
		is: "DialogueNode-element",

		properties: {
			// elements of DialogueNode, all Strings for now
			notSkippable: String,
			isQuestionNode: String,
			isTempText: String,
			playVOAs3DSound: String,
			playType: String,
			persistence: String,
			noPlayRandomWeight: String,
			displayType: String,
		},

		createLink: function(to) {
			this.$.flowchartnode.createLink(to);
		},

		fromXML: function(xml) {
			this.nodeId = this.$.flowchartnode.fromXML(xml);
			if(xml.hasChildNodes()) {
				var node;
				for (var x = 0; x < xml.childNodes.length; x++) {
					node = xml.childNodes[x];
					if (node.nodeName == "NotSkippable") {
						this.notSkippable = node.textContent;
					}
					if (node.nodeName == "IsQuestionNode") {
						this.isQuestionNode = node.textContent;
					}
					if (node.nodeName == "IsTempText") {
						this.isTempText = node.textContent;
					}
					if (node.nodeName == "PlayVOAs3DSound") {
						this.playVOAs3DSound = node.textContent;
					}
					if (node.nodeName == "PlayType") {
						this.playType = node.textContent;
					}
					if (node.nodeName == "Persistence") {
						this.persistence = node.textContent;
					}
					if (node.nodeName == "NoPlayRandomWeight") {
						this.noPlayRandomWeight = node.textContent;
					}
					if (node.nodeName == "DisplayType") {
						this.displayType = node.textContent;
					}
					// other tags of type DialogueNode are allways empty.
				}
			}
			return this.nodeId;
		},

		toXML: function(xmlstring) {
			var xml = "";
			xml += '<NotSkippable>' + this.notSkippable + '</NotSkippable>';
			xml += '<IsQuestionNode>' + this.isQuestionNode + '</IsQuestionNode>';
			xml += '<IsTempText>' + this.isTempText + '</IsTempText>';
			xml += '<PlayVOAs3DSound>' + this.playVOAs3DSound + '</PlayVOAs3DSound>';
			xml += '<PlayType>' + this.playType + '</PlayType>';
			xml += '<Persistence>' + this.persistence + '</Persistence>';
			xml += '<NoPlayRandomWeight>' + this.noPlayRandomWeight + '</NoPlayRandomWeight>';
			xml += '<DisplayType>' + this.displayType + '</DisplayType>';
			// Allways empty, just here to stay valid against the xsd
			xml += '<VOFilename /><VoiceType /><ExcludedSpeakerClasses /><ExcludedListenerClasses />  <IncludedSpeakerClasses /><IncludedListenerClasses />';
			xml += xmlstring;
			return this.$.flowchartnode.toXML(xml);
		}
	});


	window.TalkNode = Polymer({
		is: 'TalkNode-element',
		
		behaviors: [UIBehavior],
		properties: {
			actorDirection: String,
			speakerGuid: String,
			listenerGuid: String,
			type: {
				value: 'TalkNode'
			}
		},
		// hoffentlich ist das nen pointer
		factoryImpl: function(parent_) {
			this.parent_ = parent_; // da das den UIBehavior konstruktor überschreibt, und man über this.behaviors nicht gehen kann
			this.links = this.$.dialoguenode.$.flowchartnode.links;
		},
		createLink: function(to) {
			this.$.dialoguenode.createLink(to);
		},
		fromXML: function(xml) {
			this.nodeId = this.$.dialoguenode.fromXML(xml);
			if(xml.hasChildNodes()) {
				var node;
				for (var x = 0; x < xml.childNodes.length; x++) {
					node = xml.childNodes[x];
					if (node.nodeName == "ActorDirection") {
						this.actorDirection = node.textContent;
					}
					if(node.nodeName == "SpeakerGuid") {
						this.speakerGuid = node.textContent;
					}
					if(node.nodeName == "ListenerGuid") {
						this.listenerGuid = node.textContent;
					}
				}
			}
		},

		toXML: function() {
			var xml = "";
			xml += '<ActorDirection>' + this.actorDirection + '</ActorDirection>';
			xml += '<SpeakerGuid>' + this.speakerGuid + '</SpeakerGuid>';
			xml += '<ListenerGuid>' + this.listenerGuid + '</ListenerGuid>';
			return '<FlowChartNode xsi:type="' + this.type + '">' + this.$.dialoguenode.toXML(xml) + '</FlowChartNode>';
		}
	});

	window.PlayerResponseNode = Polymer({
		is: 'PlayerResponseNode-element',
		behaviors: [UIBehavior],

		properties: {
			type: {
				value: 'PlayerResponseNode'
			}
		},

		factoryImpl: function(parent_) {
			this.parent_ = parent_;
			this.links = this.$.dialoguenode.$.flowchartnode.links;
		},

		createLink: function(to) {
			this.$.dialoguenode.createLink(to);
		},
		fromXML: function(xml) {
			this.nodeId = this.$.dialoguenode.fromXML(xml);
		},

		toXML: function() {
			return '<FlowChartNode xsi:type="' + this.type + '">' + this.$.dialoguenode.toXML("") + '</FlowChartNode>';
		}
	});

	window.TriggerConversationNode = Polymer({
		is: 'TriggerConversationNode-element',
		behaviors: [UIBehavior],

		properties: {
			conversationFilename: String,
			startNodeId: Number,

			type: {
				value: 'TriggerConversationNode'
			}
		},

		factoryImpl: function(parent_) {
			this.parent_ = parent_;
			this.links = this.$.dialoguenode.$.flowchartnode.links;
		},
		fromXML: function(xml) {
			this.nodeId = this.$.dialoguenode.fromXML(xml);
			if(xml.hasChildNodes()) {
				var node;
				for (var x = 0; x < xml.childNodes.length; x++) {
					node = xml.childNodes[x];
					if (node.nodeName == "ConversationFilename") {
						this.conversationFilename = node.textContent;
					}
					if(node.nodeName == "StartNodeID") {
						this.startNodeId = node.textContent;
					}
				}
			}
		},

		toXML: function() {
			var xml = '<ConversationFilename>' + this.conversationFilename + '</ConversationFilename>';
			xml += '<StartNodeID>' + this.startNodeId + '</StartNodeID>';
			return '<FlowChartNode xsi:type="' + this.type + '">' + this.$.dialoguenode.toXML(xml) + '</FlowChartNode>';
		}
	});

	window.BankNode = Polymer({
		is: 'BankNode-element',

		behaviors: [UIBehavior],

		properties: {
			bankNodePlayType: String,
			childNodeIds: Array,
			type: {
				value: 'BankNode'
			}
		},
		
		created: function() {
			this.childNodeIds = [];
		},

		factoryImpl: function(parent_) {
			this.parent_ = parent_;
			this.links = this.$.flowchartnode.links;
		},
		createLink: function(to) {
			this.$.flowchartnode.createLink(to);
		},
		fromXML: function(xml) {
			this.nodeId = this.$.flowchartnode.fromXML(xml);
			if(xml.hasChildNodes()) {
				var node;
				for (var x = 0; x < xml.childNodes.length; x++) {
					node = xml.childNodes[x];
					if (node.nodeName == "BankNodePlayType") {
						this.bankNodePlayType = node.textContent;
					}
					if(node.nodeName == "ChildNodesIDs") {
						for(var i = 0; i < node.childNodes.length; i++) {
							this.push('childNodeIds', node.childNodes[i].textContent); 
						}
					}
				}
			}
		},

		toXML: function() {
			var xml = '<BankNodePlayType>' + this.bankNodePlayType + '</BankNodePlayType>';
			xml += '<ChildNodeIDs>';
			for(var node of this.childNodeIds) {
				xml += '<int>' + node + '</int>';
			}
			xml += '</ChildNodesIDs>';
			return '<FlowChartNode xsi:type="' + this.type + '">' + this.$.flowchartnode.toXML(xml) + '</FlowChartNode>';
		}
	});

	window.ScriptNode = Polymer({
		is: 'ScriptNode-element',

		behaviors: [UIBehavior],

		properties: {
			type: {
				value: 'ScriptNode'
			}
		},
		
		factoryImpl: function(parent_) {
			this.parent_ = parent_;	
			this.links = this.$.dialoguenode.$.flowchartnode.links;
		},
		createLink: function(to) {
			this.$.dialoguenode.createLink(to);
		},
		fromXML: function(xml) {
			this.nodeId = this.$.dialoguenode.fromXML(xml);
		},

		toXML: function() {
			return '<FlowChartNode xsi:type="' + this.type + '">' + this.$.dialoguenode.toXML("") + '</FlowChartNode>';
		}
	});
});
</script>
